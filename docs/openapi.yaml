openapi: 3.0.3
info:
  title: TaskFlow API
  version: 0.1.0
  description: |
    TaskFlow is a lightweight project & task management API.
    - Auth via JWT Bearer tokens
    - Projects CRUD with ownership enforcement
    - Tasks CRUD with filtering + cursor pagination

servers:
  - url: http://localhost:8080
    description: Local development

tags:
  - name: Health
  - name: Auth
  - name: Projects
  - name: Tasks

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorDetail:
      type: object
      additionalProperties: false
      properties:
        field:
          type: string
        message:
          type: string
      required: [field, message]

    ErrorResponse:
      type: object
      additionalProperties: false
      properties:
        error:
          type: object
          additionalProperties: false
          properties:
            code:
              type: string
              description: Stable error code (e.g. VALIDATION_ERROR)
            message:
              type: string
            details:
              type: array
              items:
                $ref: "#/components/schemas/ErrorDetail"
          required: [code, message]
      required: [error]

    Cursor:
      type: object
      additionalProperties: false
      properties:
        createdAt:
          type: string
          format: date-time
        id:
          type: string
      required: [createdAt, id]

    Project:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        name:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, name, createdAt, updatedAt]

    Task:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        projectId:
          type: string
        title:
          type: string
        completed:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, projectId, title, completed, createdAt, updatedAt]

    RegisterRequest:
      type: object
      additionalProperties: false
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
      required: [email, password]

    LoginRequest:
      type: object
      additionalProperties: false
      properties:
        email:
          type: string
          format: email
        password:
          type: string
      required: [email, password]

    CreateProjectRequest:
      type: object
      additionalProperties: false
      properties:
        name:
          type: string
          minLength: 1
      required: [name]

    UpdateProjectRequest:
      type: object
      additionalProperties: false
      properties:
        name:
          type: string
          minLength: 1
      required: [name]

    CreateTaskRequest:
      type: object
      additionalProperties: false
      properties:
        title:
          type: string
          minLength: 1
      required: [title]

    UpdateTaskRequest:
      type: object
      additionalProperties: false
      properties:
        title:
          type: string
          minLength: 1
        completed:
          type: boolean
      description: Provide at least one field.
      minProperties: 1

  responses:
    Unauthorized:
      description: Missing or invalid bearer token.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            missingToken:
              value:
                error:
                  code: UNAUTHORIZED
                  message: missing bearer token

    NotFound:
      description: Resource not found.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            notFound:
              value:
                error:
                  code: NOT_FOUND
                  message: resource not found

paths:
  /healthz:
    get:
      tags: [Health]
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  status:
                    type: string
              examples:
                ok:
                  value: { status: ok }

  /v1/auth/register:
    post:
      tags: [Auth]
      summary: Register user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  data:
                    type: object
                    additionalProperties: false
                    properties:
                      id:
                        type: string
                    required: [id]
                required: [data]
        "400":
          description: Invalid JSON
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Email already registered (or conflict)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "422":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/auth/login:
    post:
      tags: [Auth]
      summary: Login and receive JWT access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  data:
                    type: object
                    additionalProperties: false
                    properties:
                      accessToken:
                        type: string
                    required: [accessToken]
                required: [data]
        "400":
          description: Invalid JSON
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/auth/me:
    get:
      tags: [Auth]
      summary: Get current user (from JWT subject)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  data:
                    type: object
                    additionalProperties: false
                    properties:
                      id:
                        type: string
                    required: [id]
                required: [data]
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/projects:
    post:
      tags: [Projects]
      summary: Create project
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateProjectRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  data:
                    $ref: "#/components/schemas/Project"
                required: [data]
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    get:
      tags: [Projects]
      summary: List projects (cursor pagination)
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - name: cursorCreatedAt
          in: query
          schema: { type: string, format: date-time }
          description: RFC3339 timestamp from meta.nextCursor.createdAt
        - name: cursorId
          in: query
          schema: { type: string }
          description: ID from meta.nextCursor.id
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Project"
                  meta:
                    type: object
                    additionalProperties: false
                    properties:
                      nextCursor:
                        $ref: "#/components/schemas/Cursor"
                required: [data]
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/projects/{id}:
    get:
      tags: [Projects]
      summary: Get project by id
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  data:
                    $ref: "#/components/schemas/Project"
                required: [data]
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      tags: [Projects]
      summary: Update project name
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProjectRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  data:
                    $ref: "#/components/schemas/Project"
                required: [data]
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    delete:
      tags: [Projects]
      summary: Delete project
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "204":
          description: No Content
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/projects/{projectId}/tasks:
    post:
      tags: [Tasks]
      summary: Create task under a project
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTaskRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  data:
                    $ref: "#/components/schemas/Task"
                required: [data]
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Project not found (or not owned)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "422":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/tasks:
    get:
      tags: [Tasks]
      summary: List tasks (filter + cursor pagination)
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: query
          required: true
          schema: { type: string }
        - name: completed
          in: query
          required: false
          schema: { type: boolean }
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - name: cursorCreatedAt
          in: query
          schema: { type: string, format: date-time }
        - name: cursorId
          in: query
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Task"
                  meta:
                    type: object
                    additionalProperties: false
                    properties:
                      nextCursor:
                        $ref: "#/components/schemas/Cursor"
                required: [data]
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          description: Validation error (missing/invalid query)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /v1/tasks/{id}:
    get:
      tags: [Tasks]
      summary: Get task by id
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  data:
                    $ref: "#/components/schemas/Task"
                required: [data]
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      tags: [Tasks]
      summary: Update task (title and/or completed)
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateTaskRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  data:
                    $ref: "#/components/schemas/Task"
                required: [data]
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    delete:
      tags: [Tasks]
      summary: Delete task
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "204":
          description: No Content
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
